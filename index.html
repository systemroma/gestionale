<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionale Incassi Corsi</title>
    <!-- Carica Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carica il font Inter -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        /* Applica il font Inter come default */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Stile per un loader semplice */
        .loader {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Contenitore Autenticazione (Visibile di default) -->
    <div id="login-container" class="min-h-screen flex items-center justify-center p-4">
        <div class="max-w-md w-full bg-white p-8 rounded-lg shadow-md">
            
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Accesso Gestionale</h2>

            <!-- Messaggio di Errore Autenticazione -->
            <div id="auth-error-message" class="p-4 mb-4 text-sm text-red-800 bg-red-100 rounded-lg hidden" role="alert">
                <span class="font-medium">Errore:</span> <span id="auth-error-text"></span>
            </div>

            <!-- Form di Login -->
            <form id="login-form" class="space-y-4 mb-6">
                <div>
                    <label for="login-email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="login-email" name="email" class="w-full mt-1 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="login-password" name="password" class="w-full mt-1 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <button type="submit" id="login-btn" class="w-full bg-blue-600 text-white p-3 rounded-md font-semibold hover:bg-blue-700 transition duration-200 shadow-md">
                    Accedi
                </button>
            </form>
            
            <p class="text-xs text-center text-gray-500">
                Solo l'utente admin pre-configurato può accedere.
            </p>

        </div>
    </div>

    <!-- Contenitore App Principale (Nascosto di default) -->
    <div id="app-container" class="container mx-auto p-4 md:p-8 max-w-7xl hidden">
        
        <!-- Intestazione -->
        <header class="mb-6 flex justify-between items-center">
            <div>
                <h1 class="text-4xl font-bold text-gray-800">Gestionale Incassi Corsi</h1>
                <p id="auth-status" class="text-gray-600 mt-1">
                    Connessione in corso...
                </p>
            </div>
            <button id="logout-btn" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition shadow-md">
                Logout
            </button>
        </header>

        <!-- Riepilogo Finanziario a Scomparsa -->
        <div class="bg-white p-4 rounded-lg shadow-md mb-6">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-semibold text-gray-800">Riepilogo Finanziario</h2>
                <button id="toggle-summary-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition">
                    Mostra
                </button>
            </div>
            
            <!-- Contenuto del Riepilogo (Nascosto di default) -->
            <div id="summary-content" class="hidden mt-4 pt-4 border-t border-gray-200 grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <p class="text-sm font-medium text-gray-500 uppercase">Totale Incassi</p>
                    <p id="total-incassi" class="text-3xl font-bold text-green-600">€0.00</p>
                </div>
                <div>
                    <p class="text-sm font-medium text-gray-500 uppercase">Totale Uscite</p>
                    <p id="total-uscite" class="text-3xl font-bold text-red-600">€0.00</p>
                </div>
                <div>
                    <p class="text-sm font-medium text-gray-500 uppercase">Saldo Attuale</p>
                    <p id="total-saldo" class="text-3xl font-bold text-blue-700">€0.00</p>
                </div>
            </div>
        </div>

        <!-- Contenuto Principale: Form + Lista -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- Colonna 1: Form Aggiungi Incasso -->
            <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-5 text-gray-800 border-b pb-2">
                    Aggiungi Movimento
                </h2>

                <!-- Messaggio di Errore App -->
                <div id="error-message" class="p-4 mb-4 text-sm text-red-800 bg-red-100 rounded-lg hidden" role="alert">
                    <span class="font-medium">Errore:</span> <span id="error-text"></span>
                </div>

                <!-- Form -->
                <form id="incasso-form" class="space-y-4">
                    
                    <!-- Campo: Corso -->
                    <div>
                        <label for="corso" class="block text-sm font-medium text-gray-700 mb-1">
                            Corso
                        </label>
                        <select id="corso" name="corso" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option>Corso Base di Programmazione</option>
                            <option>Corso Avanzato di Design</option>
                            <option>Workshop Marketing Digitale</option>
                            <option>Seminario Public Speaking</option>
                            <option>Altro</option>
                        </select>
                    </div>

                    <!-- Campo: Data -->
                    <div>
                        <label for="data" class="block text-sm font-medium text-gray-700 mb-1">
                            Data Svolgimento
                        </label>
                        <input type="date" id="data" name="data" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                    </div>

                    <!-- Campo: Costo per Partecipante -->
                    <div>
                        <label for="costo-per-partecipante" class="block text-sm font-medium text-gray-700 mb-1">
                            Costo per Partecipante (€)
                        </label>
                        <input type="number" id="costo-per-partecipante" name="costo-per-partecipante" min="0" step="0.01" placeholder="Es. 50" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                    </div>

                    <!-- Campo: Numero Partecipanti -->
                    <div>
                        <label for="num-partecipanti" class="block text-sm font-medium text-gray-700 mb-1">
                            Numero Partecipanti
                        </label>
                        <input type="number" id="num-partecipanti" name="num-partecipanti" min="1" step="1" placeholder="Es. 10" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                    </div>

                    <!-- Campo: Costo Libero -->
                    <div>
                        <label for="costo-libero" class="block text-sm font-medium text-gray-700 mb-1">
                            Costi Extra Incasso (€) <span class="text-gray-500">(Opzionale)</span>
                        </label>
                        <input type="number" id="costo-libero" name="costo-libero" min="0" step="0.01" placeholder="Es. 25.50" value="0" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- Campo: Costo Personale (Uscita) -->
                    <div class="pt-4 border-t mt-4">
                        <label for="costo-personale" class="block text-sm font-medium text-gray-700 mb-1">
                            Costo Personale (Uscita) <span class="text-gray-500">(Opzionale)</span>
                        </label>
                        <input type="number" id="costo-personale" name="costo-personale" min="0" step="0.01" placeholder="Es. 100" value="0" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <p class="text-xs text-gray-500 mt-1">Verrà salvato come un'uscita separata con la stessa data.</p>
                    </div>

                    <!-- Riepilogo Calcolo -->
                    <div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <h3 class="text-lg font-semibold text-gray-800">Totale Incasso Calcolato</h3>
                        <p id="calcolo-totale" class="text-xl font-bold text-blue-600">
                            €0.00
                        </p>
                    </div>

                    <!-- Pulsante Submit -->
                    <button type="submit" id="submit-btn" class="w-full bg-blue-600 text-white p-3 rounded-md font-semibold hover:bg-blue-700 transition duration-200 shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                        Salva Movimento
                    </button>
                </form>
            </div>

            <!-- Colonna 2: Lista dei Movimenti (Incassi + Uscite) -->
            <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-5 text-gray-800 border-b pb-2">
                    Movimenti Registrati
                </h2>
                
                <!-- Stato di Caricamento -->
                <div id="loading-state" class="text-center p-10 text-gray-600">
                    <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mx-auto mb-4"></div>
                    <p>Caricamento movimenti dal database...</p>
                </div>
                
                <!-- Stato Vuoto -->
                <div id="empty-state" class="text-center p-10 bg-gray-50 rounded-lg hidden">
                    <p class="text-gray-600">Nessun movimento ancora registrato.</p>
                    <p class="text-sm text-gray-500 mt-1">Compila il modulo a sinistra per iniziare.</p>
                </div>
                
                <!-- Lista Movimenti -->
                <ul id="movimenti-list" class="space-y-4 max-h-[80vh] overflow-y-auto pr-2">
                    <!-- Gli elementi (incassi e uscite) verranno aggiunti qui da JS -->
                </ul>
            </div>

        </div>
    </div>

    <!-- CARICA LA CONFIGURAZIONE PRIMA DELLO SCRIPT PRINCIPALE -->
    <script src="firebase-config.js"></script>

    <!-- Script per Firebase e logica dell'app -->
    <script type="module">
      // Import necessari da Firebase
      import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import { 
        getAuth, 
        onAuthStateChanged,
        // RIMOSSO: createUserWithEmailAndPassword (non c'è registrazione)
        signInWithEmailAndPassword,     // Per il Login
        signOut                         // Per il Logout
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import { 
        getFirestore,
        collection,
        doc,
        onSnapshot,
        addDoc,
        deleteDoc,
        query
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // --- Variabili Globali ---
      
      // La variabile `firebaseConfig` ora è caricata dal file esterno `firebase-config.js`
      
      // Controllo per assicurarsi che il file sia stato caricato
      if (typeof firebaseConfig === 'undefined' || firebaseConfig.projectId === "INCOLLA_QUI_projectId") {
        const errorMsg = "ERRORE: `firebaseConfig` non trovato o non valido. Assicurati che `firebase-config.js` sia presente, salvato, e contenga la tua vera configurazione Firebase.";
        console.error(errorMsg);
        document.body.innerHTML = `<div class="p-8 text-center text-red-600">${errorMsg}</div>`;
        throw new Error(errorMsg);
      }
      
      const appId = firebaseConfig.projectId || 'default-app-id';
      
      // ----------------------------------------------------

      // Variabili di stato globali
      let db, auth, userId, isAuthReady = false;
      let pathIncassi = ''; 
      let localIncassi = []; 
      let pathUscite = ''; 
      let localUscite = [];
      
      // Listener di Firestore (per staccarli al logout)
      let unsubscribeIncassi = () => {};
      let unsubscribeUscite = () => {};

      // Elementi DOM (App)
      const appContainer = document.getElementById('app-container');
      const authStatus = document.getElementById('auth-status');
      const logoutBtn = document.getElementById('logout-btn');
      const incassoForm = document.getElementById('incasso-form');
      const submitBtn = document.getElementById('submit-btn');
      const movimentiList = document.getElementById('movimenti-list');
      const loadingState = document.getElementById('loading-state');
      const emptyState = document.getElementById('empty-state');
      
      // Elementi DOM (Auth)
      const loginContainer = document.getElementById('login-container');
      const loginForm = document.getElementById('login-form');
      // RIMOSSO: registerForm
      const authErrorMessage = document.getElementById('auth-error-message');
      const authErrorText = document.getElementById('auth-error-text');

      // Elementi Form (App)
      const dataInput = document.getElementById('data');
      const costoInput = document.getElementById('costo-per-partecipante');
      const numInput = document.getElementById('num-partecipanti');
      const liberoInput = document.getElementById('costo-libero');
      const costoPersonaleInput = document.getElementById('costo-personale');
      const calcoloTotale = document.getElementById('calcolo-totale');
      
      // Elementi Riepilogo (App)
      const toggleSummaryBtn = document.getElementById('toggle-summary-btn');
      const summaryContent = document.getElementById('summary-content');
      const totalIncassiEl = document.getElementById('total-incassi');
      const totalUsciteEl = document.getElementById('total-uscite');
      const totalSaldoEl = document.getElementById('total-saldo');
      
      // Elementi Errore (App)
      const errorMessage = document.getElementById('error-message');
      const errorText = document.getElementById('error-text');

      /**
       * Inizializza l'applicazione al caricamento della pagina
       */
      document.addEventListener('DOMContentLoaded', () => {
        initializeFirebase();
        setupFormListeners(); // Listener per il form dell'app
        setupAuthForms(); // Listener per login/logout
        setupSummaryToggle();
        
        // Imposta la data di oggi come default
        (dataInput).valueAsDate = new Date();
      });

      /**
       * 1. Inizializza Firebase
       */
      function initializeFirebase() {
        setLogLevel('Debug');
        try {
          const app = initializeApp(firebaseConfig);
          db = getFirestore(app); 
          auth = getAuth(app);
          console.log("Firebase (Cloud Firestore) inizializzato correttamente.");
          setupAuthListener(); // Avvia il listener principale
        } catch (e) {
          console.error("Errore inizializzazione Firebase:", e);
          showAuthError(`Errore inizializzazione Firebase: ${e.message}`);
        }
      }

      /**
       * 2. Imposta il listener per lo stato di autenticazione (cuore dell'app)
       */
      function setupAuthListener() {
        onAuthStateChanged(auth, (user) => {
          // Stacca i vecchi listener prima di fare qualsiasi cosa
          unsubscribeIncassi();
          unsubscribeUscite();

          if (user) {
            // --- UTENTE LOGGATO ---
            console.log("Utente loggato:", user.uid);
            onUserAuthenticated(user);
            appContainer.classList.remove('hidden');
            loginContainer.classList.add('hidden');
            hideAuthError();
          } else {
            // --- UTENTE NON LOGGATO (LOGOUT) ---
            console.log("Nessun utente loggato.");
            userId = null;
            isAuthReady = false;
            appContainer.classList.add('hidden');
            loginContainer.classList.remove('hidden');
            
            // Pulisci i dati vecchi
            localIncassi = [];
            localUscite = [];
            renderMovimentiList();
            updateSummary();
            authStatus.textContent = "Disconnesso.";
          }
        });
      }

      /**
       * 3. Imposta i listener per i form di login e logout
       */
      function setupAuthForms() {
        // RIMOSSO: registerForm.addEventListener
        loginForm.addEventListener('submit', handleLogin);
        logoutBtn.addEventListener('click', handleLogout);
      }

      /**
       * 3a. Gestisce il login
       */
      async function handleLogin(e) {
        e.preventDefault();
        hideAuthError();
        const email = (e.target).email.value;
        const password = (e.target).password.value;

        try {
          await signInWithEmailAndPassword(auth, email, password);
          // onAuthStateChanged si occuperà del resto
        } catch (error) {
          console.error("Errore login:", error.code);
          showAuthError(getFriendlyAuthError(error.code));
        }
      }

      /**
       * 3b. Gestisce il logout
       */
      function handleLogout() {
        signOut(auth).catch(error => {
          console.error("Errore logout:", error);
          showError("Errore durante il logout."); // Mostra errore nell'app
        });
      }

      /**
       * 4. Chiamata quando l'utente è autenticato con successo
       */
      function onUserAuthenticated(user) {
        userId = user.uid;
        isAuthReady = true;

        // Path standard per i dati privati dell'utente
        pathIncassi = `users/${userId}/incassi`;
        pathUscite = `users/${userId}/uscite`;
        
        console.log(`Path database incassi (Firestore): ${pathIncassi}`);
        console.log(`Path database uscite (Firestore): ${pathUscite}`);
        
        authStatus.textContent = `Connesso come: ${user.email}`;
        (submitBtn).disabled = false;
        
        // Avvia i listener per i dati
        setupSnapshotListenerIncassi();
        setupSnapshotListenerUscite();
      }

      /**
       * 5a. Si mette in ascolto dei cambiamenti sul database (INCASSI)
       */
      function setupSnapshotListenerIncassi() {
        if (!db || !pathIncassi) return;
        const q = query(collection(db, pathIncassi)); 

        // Salva la funzione di unsubscribe per staccarla al logout
        unsubscribeIncassi = onSnapshot(q, (snapshot) => { 
          console.log("Dati (Incassi) ricevuti da Firestore.");
          localIncassi = [];
          snapshot.docs.forEach((doc) => {
            localIncassi.push({ id: doc.id, ...doc.data() });
          });
          renderMovimentiList();
          updateSummary();
        }, (error) => {
          console.error("Errore in onSnapshot (Incassi):", error);
          showError(`Impossibile caricare gli incassi: ${error.message}`);
          loadingState.classList.add('hidden');
        });
      }

      /**
       * 5b. Si mette in ascolto dei cambiamenti sul database (USCITE)
       */
      function setupSnapshotListenerUscite() {
        if (!db || !pathUscite) return;
        const q = query(collection(db, pathUscite)); 

        // Salva la funzione di unsubscribe
        unsubscribeUscite = onSnapshot(q, (snapshot) => { 
          console.log("Dati (Uscite) ricevuti da Firestore.");
          localUscite = [];
          snapshot.docs.forEach((doc) => {
            localUscite.push({ id: doc.id, ...doc.data() });
          });
          renderMovimentiList();
          updateSummary();
        }, (error) => {
          console.error("Errore in onSnapshot (Uscite):", error);
          showError(`Impossibile caricare le uscite: ${error.message}`);
          loadingState.classList.add('hidden');
        });
      }

      /**
       * 6. Imposta i listener sul form dell'app
       */
      function setupFormListeners() {
        const inputs = [costoInput, numInput, liberoInput];
        inputs.forEach(input => {
          input.addEventListener('input', updateCalcoloTotale);
        });
        incassoForm.addEventListener('submit', handleSubmit);
      }
      
      /**
       * 6b. Imposta il listener per il toggle del riepilogo
       */
      function setupSummaryToggle() {
        toggleSummaryBtn.addEventListener('click', () => {
          const isHidden = summaryContent.classList.toggle('hidden');
          toggleSummaryBtn.textContent = isHidden ? 'Mostra' : 'Nascondi';
        });
      }

      /**
       * 7. Gestisce il submit del form (INCASSO + USCITA OPZIONALE)
       */
      async function handleSubmit(event) {
        event.preventDefault(); 
        if (!isAuthReady) {
          showError("Autenticazione non ancora pronta.");
          return;
        }

        (submitBtn).disabled = true;
        submitBtn.textContent = "Salvataggio in corso...";

        const form = event.target;
        const dataIncasso = {
          corso: (form).corso.value,
          data: (form).data.value,
          costoPerPartecipante: parseFloat((form)['costo-per-partecipante'].value),
          numPartecipanti: parseInt((form)['num-partecipanti'].value),
          costoLibero: parseFloat((form)['costo-libero'].value) || 0,
          userId: userId, // Associa l'incasso all'utente
          totale: 0 
        };
        dataIncasso.totale = (dataIncasso.costoPerPartecipante * dataIncasso.numPartecipanti) + dataIncasso.costoLibero;

        const costoPersonale = parseFloat((form)['costo-personale'].value) || 0;

        try {
          hideError();
          await addDoc(collection(db, pathIncassi), dataIncasso);
          console.log("Incasso salvato con successo!");
          
          if (costoPersonale > 0) {
            const dataUscita = {
              descrizione: "Costo Personale",
              data: (dataInput).value, 
              importo: costoPersonale,
              userId: userId // Associa l'uscita all'utente
            };
            await addDoc(collection(db, pathUscite), dataUscita);
            console.log("Uscita 'Costo Personale' salvata con successo!");
          }
          
          (form).reset();
          (dataInput).valueAsDate = new Date(); 
          updateCalcoloTotale(); 

        } catch (e) {
          console.error("Errore nel salvataggio:", e);
          showError(`Errore nel salvataggio: ${e.message}`);
        } finally {
          (submitBtn).disabled = false;
          submitBtn.textContent = "Salva Movimento";
        }
      }

      /**
       * 7. Renderizza l'intera lista dei movimenti (incassi + uscite)
       */
      function renderMovimentiList() {
        movimentiList.innerHTML = ''; 

        const tuttiMovimenti = [
            ...localIncassi.map(i => ({ ...i, type: 'incasso' })),
            ...localUscite.map(u => ({ ...u, type: 'uscita' }))
        ];

        tuttiMovimenti.sort((a, b) => b.data.localeCompare(a.data));

        if (tuttiMovimenti.length === 0) {
          emptyState.classList.remove('hidden');
          loadingState.classList.add('hidden');
        } else {
          emptyState.classList.add('hidden');
          loadingState.classList.add('hidden');

          tuttiMovimenti.forEach(movimento => {
            const li = document.createElement('li');
            li.className = "bg-white border border-gray-200 p-4 rounded-lg shadow-sm flex items-center justify-between";
            
            if (movimento.type === 'incasso') {
                li.innerHTML = createIncassoHTML(movimento);
                li.querySelector('button').addEventListener('click', () => deleteIncasso(movimento.id));
            } else {
                li.innerHTML = createUscitaHTML(movimento);
                li.querySelector('button').addEventListener('click', () => deleteUscita(movimento.id));
            }
            movimentiList.appendChild(li);
          });
        }
      }
      
      /**
       * 7a. Elimina un documento da Firestore (INCASSO)
       */
      async function deleteIncasso(docId) {
        const sic = prompt("Sei sicuro di voler eliminare questo incasso? Scrivi 'SI' per confermare.");
        if (sic !== 'SI') return;

        try {
          hideError();
          const docRef = doc(db, pathIncassi, docId); 
          await deleteDoc(docRef); 
          console.log("Documento (Incasso) eliminato:", docId);
        } catch (e) {
          console.error("Errore eliminazione incasso:", e);
          showError(`Errore eliminazione incasso: ${e.message}`);
        }
      }
      
      /**
       * 7b. Elimina un documento da Firestore (USCITA)
       */
      async function deleteUscita(docId) {
        const sic = prompt("Sei sicuro di voler eliminare questa uscita? Scrivi 'SI' per confermare.");
        if (sic !== 'SI') return;

        try {
          hideError();
          const docRef = doc(db, pathUscite, docId); 
          await deleteDoc(docRef); 
          console.log("Documento (Uscita) eliminato:", docId);
        } catch (e) {
          console.error("Errore eliminazione uscita:", e);
          showError(`Errore eliminazione uscita: ${e.message}`);
        }
      }

      /**
       * 8. Aggiorna il riepilogo finanziario
       */
      function updateSummary() {
          const totaleIncassi = localIncassi.reduce((sum, item) => sum + item.totale, 0);
          const totaleUscite = localUscite.reduce((sum, item) => sum + item.importo, 0);
          const saldo = totaleIncassi - totaleUscite;

          totalIncassiEl.textContent = formatCurrency(totaleIncassi);
          totalUsciteEl.textContent = formatCurrency(totaleUscite);
          totalSaldoEl.textContent = formatCurrency(saldo);
      }

      /**
       * 9. Aggiorna il calcolo del totale nel form
       */
      function updateCalcoloTotale() {
        const costo = parseFloat((costoInput).value) || 0;
        const num = parseInt((numInput).value) || 0;
        const libero = parseFloat((liberoInput).value) || 0;
        const totale = (costo * num) + libero;
        calcoloTotale.textContent = formatCurrency(totale);
      }

      // --- Funzioni di Utility (Errori) ---

      function showError(message) {
        errorText.textContent = message;
        errorMessage.classList.remove('hidden');
      }
      function hideError() {
        errorMessage.classList.add('hidden');
        errorText.textContent = '';
      }
      function showAuthError(message) {
        authErrorText.textContent = message;
        authErrorMessage.classList.remove('hidden');
      }
      function hideAuthError() {
        authErrorMessage.classList.add('hidden');
        authErrorText.textContent = '';
      }
      function getFriendlyAuthError(code) {
        switch (code) {
          case 'auth/user-not-found':
            return "Nessun utente trovato con questa email.";
          case 'auth/wrong-password':
            return "Password errata. Riprova.";
          case 'auth/invalid-email':
            return "Formato email non valido.";
          default:
            return `Errore sconosciuto: ${code}`;
        }
      }

      // --- Funzioni di Utility (Formattazione) ---

      function formatCurrency(value) {
        return new Intl.NumberFormat('it-IT', {
          style: 'currency',
          currency: 'EUR'
        }).format(value || 0);
      }
      function formatDate(dateString) {
          try {
              const [year, month, day] = dateString.split('-');
              return `${day}/${month}/${year}`;
          } catch (e) {
              return dateString; // Fallback
          }
      }
      
      // --- Funzioni di Utility (HTML Templates) ---

      function createIncassoHTML(incasso) {
          return `
              <div class="flex-1">
                  <p class="text-sm text-gray-500">${formatDate(incasso.data)}</p>
                  <p class="text-lg font-semibold text-green-700">
                      + ${formatCurrency(incasso.totale)} (Incasso)
                  </p>
                  <p class="text-sm text-gray-700 font-medium">
                      ${incasso.corso}
                  </p>
                  <p class="text-xs text-gray-500">
                      Dettagli: ${incasso.numPartecipanti} x ${formatCurrency(incasso.costoPerPartecipante)}
                      ${incasso.costoLibero > 0 ? ` + ${formatCurrency(incasso.costoLibero)} extra` : ''}
                  </p>
              </div>
              <button class="flex-shrink-0 bg-red-500 text-white p-2 rounded-md hover:bg-red-600 transition duration-200 shadow-sm" aria-label="Elimina incasso">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                  </svg>
              </button>
          `;
      }
      function createUscitaHTML(uscita) {
          return `
              <div class="flex-1">
                  <p class="text-sm text-gray-500">${formatDate(uscita.data)}</p>
                  <p class="text-lg font-semibold text-red-700">
                      - ${formatCurrency(uscita.importo)} (Uscita)
                  </p>
                  <p class="text-sm text-gray-700 font-medium">
                      ${uscita.descrizione}
                  </p>
              </div>
              <button class="flex-shrink-0 bg-red-500 text-white p-2 rounded-md hover:bg-red-600 transition duration-200 shadow-sm" aria-label="Elimina uscita">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                  </svg>
              </button>
          `;
      }

    </script>

</body>
</html>
